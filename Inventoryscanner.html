<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manual Trigger Scanner</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 20px; text-align: center; background-color: #f4f4f9; max-width: 600px; margin: 0 auto; }
        h2 { color: #333; margin-bottom: 10px; }
        
        /* Camera Viewport */
        #reader { width: 100%; margin: 0 auto; background: #000; border-radius: 8px; min-height: 300px; position: relative; }
        
        /* The Big Scan Button */
        #scan-trigger {
            display: none; /* Hidden until camera starts */
            width: 100%;
            padding: 20px;
            font-size: 22px;
            font-weight: bold;
            color: white;
            background-color: #007bff;
            border: none;
            border-radius: 12px;
            margin-top: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            cursor: pointer;
        }
        #scan-trigger:active { transform: scale(0.98); box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        #scan-trigger.waiting { background-color: #ffc107; color: #000; animation: pulse 1.5s infinite; }
        
        /* Helper Buttons */
        .btn-group { margin-top: 15px; display: flex; justify-content: center; gap: 10px; }
        button.secondary { padding: 10px 15px; font-size: 14px; border: none; border-radius: 6px; cursor: pointer; color: white; }
        .btn-stop { background-color: #dc3545; }
        .btn-dl { background-color: #28a745; width: 100%; margin-top: 20px; padding: 15px; font-size: 18px; }
        .btn-clear { background-color: #6c757d; }

        /* Status & List */
        #status-msg { margin: 10px 0; font-weight: bold; min-height: 1.2em; color: #555; }
        #result-list { list-style: none; padding: 0; background: white; border-radius: 8px; margin-top: 20px; text-align: left; max-height: 300px; overflow-y: auto; border: 1px solid #ddd; }
        #result-list li { padding: 12px 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        #result-list li:first-child { background-color: #e8f5e9; font-weight: bold; border-left: 5px solid #28a745; } /* Highlight newest */
        .ts { font-size: 0.8em; color: #888; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <h2>Retail Labs Store Inventory Scanner</h2>
    
    <div id="reader"></div>
    
    <div id="status-msg">Click "Start Camera" to begin</div>

    <button id="scan-trigger" onclick="activateTrigger()">TAP TO SCAN ITEM</button>

    <div class="btn-group">
        <button class="secondary" style="background-color: #007bff;" onclick="startCamera()">Start Camera</button>
        <button class="secondary btn-stop" onclick="stopCamera()">Stop Camera</button>
        <button class="secondary btn-clear" onclick="clearList()">Clear List</button>
    </div>

    <button class="secondary btn-dl" onclick="downloadCSV()">‚¨áÔ∏è Download CSV (<span id="count">0</span>)</button>
    
    <ul id="result-list"></ul>

    <script>
        let html5QrcodeScanner;
        let scannedData = JSON.parse(localStorage.getItem('inventoryScans')) || [];
        
        // This is the "Gate" variable. 
        // False = Ignore everything camera sees. 
        // True = Capture the next thing camera sees.
        let isCaptureMode = false; 

        const statusMsg = document.getElementById('status-msg');
        const triggerBtn = document.getElementById('scan-trigger');
        const beepSound = new Audio('https://www.soundjay.com/buttons_c2026/sounds/button-20.mp3');

        function renderList() {
            const list = document.getElementById('result-list');
            document.getElementById('count').innerText = scannedData.length;
            list.innerHTML = '';
            // Show newest on top
            scannedData.slice().reverse().forEach(item => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${item.code}</span> <span class="ts">${item.time}</span>`;
                list.appendChild(li);
            });
        }

        function onScanSuccess(decodedText, decodedResult) {
            // 1. If we are NOT in capture mode, ignore the result.
            if (!isCaptureMode) {
                return; 
            }

            // 2. If we ARE in capture mode, save it!
            
            // Turn off capture mode immediately so we don't double-scan
            isCaptureMode = false;
            resetTriggerButton();

            // Save Data
            const timestamp = new Date().toLocaleTimeString();
            scannedData.push({ code: decodedText, time: timestamp });
            localStorage.setItem('inventoryScans', JSON.stringify(scannedData));
            
            // Feedback
            renderList();
            statusMsg.innerText = `‚úÖ Saved: ${decodedText}`;
            statusMsg.style.color = "green";
            beepSound.play().catch(e => console.log("Audio error"));
        }

        function activateTrigger() {
            if (!html5QrcodeScanner) {
                alert("Please start the camera first.");
                return;
            }
            isCaptureMode = true;
            statusMsg.innerText = "üëÄ Looking for barcode...";
            statusMsg.style.color = "#d39e00";
            
            // Visual change to button
            triggerBtn.innerText = "Scanning... Point at Item";
            triggerBtn.classList.add("waiting");
        }

        function resetTriggerButton() {
            triggerBtn.innerText = "TAP TO SCAN NEXT ITEM";
            triggerBtn.classList.remove("waiting");
        }

        function startCamera() {
             if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                alert("Error: You need HTTPS. Please use Netlify Drop.");
                return;
            }

            html5QrcodeScanner = new Html5Qrcode("reader");
            const config = { fps: 15, qrbox: { width: 250, height: 250 } };
            
            html5QrcodeScanner.start({ facingMode: "environment" }, config, onScanSuccess)
            .then(() => {
                statusMsg.innerText = "Camera Ready.";
                statusMsg.style.color = "black";
                triggerBtn.style.display = "block"; // Show the big button
            })
            .catch(err => {
                alert("Camera Error: " + err);
            });
        }

        function stopCamera() {
            if(html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(() => {
                    html5QrcodeScanner.clear();
                    triggerBtn.style.display = "none";
                    statusMsg.innerText = "Camera Stopped";
                });
            }
        }

        function downloadCSV() {
            if(scannedData.length === 0) { alert("List is empty"); return; }
            let csvContent = "data:text/csv;charset=utf-8,Barcode,Timestamp\n";
            scannedData.forEach(row => { csvContent += `${row.code},${row.time}\n`; });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "inventory_scan.csv");
            document.body.appendChild(link);
            link.click();
        }

        function clearList() {
            if(confirm("Clear list?")) {
                scannedData = [];
                localStorage.setItem('inventoryScans', JSON.stringify(scannedData));
                renderList();
            }
        }

        renderList();
    </script>
</body>
</html>
